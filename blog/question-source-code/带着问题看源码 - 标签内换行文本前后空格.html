<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>问题 | Ertsul&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://s2.loli.net/2022/04/02/uCOBfH6XgGUEdPt.png">
    <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://s2.loli.net/2022/04/02/uCOBfH6XgGUEdPt.png">
    <style type="text/css">.logo {height: 2.2rem!important; width: 2.2rem!important;border-radius: 100%;margin-right: 0.8rem;vertical-align: top;}</style>
    <meta name="description" content="记录所学">
    
    <link rel="preload" href="/blog/assets/css/0.styles.214aaa3c.css" as="style"><link rel="preload" href="/blog/assets/js/app.cacff740.js" as="script"><link rel="preload" href="/blog/assets/js/2.9a122aa2.js" as="script"><link rel="preload" href="/blog/assets/js/13.58e1ee01.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0a20ab75.js"><link rel="prefetch" href="/blog/assets/js/11.5effad7b.js"><link rel="prefetch" href="/blog/assets/js/12.e72280e4.js"><link rel="prefetch" href="/blog/assets/js/14.b3199019.js"><link rel="prefetch" href="/blog/assets/js/15.5e07c399.js"><link rel="prefetch" href="/blog/assets/js/16.7cfea898.js"><link rel="prefetch" href="/blog/assets/js/17.72944865.js"><link rel="prefetch" href="/blog/assets/js/18.ccdff12f.js"><link rel="prefetch" href="/blog/assets/js/19.24e1f187.js"><link rel="prefetch" href="/blog/assets/js/20.f0864188.js"><link rel="prefetch" href="/blog/assets/js/21.8c4258cf.js"><link rel="prefetch" href="/blog/assets/js/22.ea0b7ad3.js"><link rel="prefetch" href="/blog/assets/js/23.f0dea7dc.js"><link rel="prefetch" href="/blog/assets/js/24.4afee177.js"><link rel="prefetch" href="/blog/assets/js/25.75fc8480.js"><link rel="prefetch" href="/blog/assets/js/26.4f8f8ad0.js"><link rel="prefetch" href="/blog/assets/js/27.2c78cdfa.js"><link rel="prefetch" href="/blog/assets/js/28.f04bb25b.js"><link rel="prefetch" href="/blog/assets/js/29.12b723c5.js"><link rel="prefetch" href="/blog/assets/js/3.6bef62cd.js"><link rel="prefetch" href="/blog/assets/js/30.5225f3ff.js"><link rel="prefetch" href="/blog/assets/js/31.2ffac8d3.js"><link rel="prefetch" href="/blog/assets/js/32.5d25bba1.js"><link rel="prefetch" href="/blog/assets/js/33.b91c7e77.js"><link rel="prefetch" href="/blog/assets/js/34.6c2c747c.js"><link rel="prefetch" href="/blog/assets/js/35.5e1eb71e.js"><link rel="prefetch" href="/blog/assets/js/36.0b1f0858.js"><link rel="prefetch" href="/blog/assets/js/37.7d0eaebe.js"><link rel="prefetch" href="/blog/assets/js/38.c5e4174d.js"><link rel="prefetch" href="/blog/assets/js/39.898286b0.js"><link rel="prefetch" href="/blog/assets/js/4.cf3b9bbf.js"><link rel="prefetch" href="/blog/assets/js/40.7745f0eb.js"><link rel="prefetch" href="/blog/assets/js/41.32f10a8a.js"><link rel="prefetch" href="/blog/assets/js/42.8f1903ae.js"><link rel="prefetch" href="/blog/assets/js/43.1021beed.js"><link rel="prefetch" href="/blog/assets/js/44.82755b16.js"><link rel="prefetch" href="/blog/assets/js/45.d92f822a.js"><link rel="prefetch" href="/blog/assets/js/46.878de298.js"><link rel="prefetch" href="/blog/assets/js/47.1d498896.js"><link rel="prefetch" href="/blog/assets/js/48.6ecf27ac.js"><link rel="prefetch" href="/blog/assets/js/49.a501c83e.js"><link rel="prefetch" href="/blog/assets/js/5.7811a1f4.js"><link rel="prefetch" href="/blog/assets/js/50.9cda95de.js"><link rel="prefetch" href="/blog/assets/js/51.d6171932.js"><link rel="prefetch" href="/blog/assets/js/52.6772984d.js"><link rel="prefetch" href="/blog/assets/js/53.b46d9d38.js"><link rel="prefetch" href="/blog/assets/js/54.35c6cec2.js"><link rel="prefetch" href="/blog/assets/js/55.e12d18ac.js"><link rel="prefetch" href="/blog/assets/js/56.e5376c4c.js"><link rel="prefetch" href="/blog/assets/js/57.98483f32.js"><link rel="prefetch" href="/blog/assets/js/58.3d0dbb6e.js"><link rel="prefetch" href="/blog/assets/js/59.18d97c5c.js"><link rel="prefetch" href="/blog/assets/js/6.803e0aed.js"><link rel="prefetch" href="/blog/assets/js/60.ce0d4fa0.js"><link rel="prefetch" href="/blog/assets/js/61.cf801acc.js"><link rel="prefetch" href="/blog/assets/js/62.e76db14b.js"><link rel="prefetch" href="/blog/assets/js/63.16c67f1f.js"><link rel="prefetch" href="/blog/assets/js/64.b5ff4146.js"><link rel="prefetch" href="/blog/assets/js/65.aaa52929.js"><link rel="prefetch" href="/blog/assets/js/66.dfd15524.js"><link rel="prefetch" href="/blog/assets/js/67.f47c7668.js"><link rel="prefetch" href="/blog/assets/js/7.303b47c7.js"><link rel="prefetch" href="/blog/assets/js/8.60719c31.js"><link rel="prefetch" href="/blog/assets/js/9.6e65a2c1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.214aaa3c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="https://s2.loli.net/2022/04/12/T3dGOP1mI9BZMRw.jpg" alt="Ertsul's Blog" class="logo"> <span class="site-name can-hide">Ertsul's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue-source-code/Vue 源码阅读1 引入vue模块/" class="nav-link">
  Vue 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue3-source-code/vue3 响应式原理/" class="nav-link">
  vue3 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue-router/vue-router 源码阅读（一）/" class="nav-link">
  vue-router 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vuex/vuex 源码阅读/" class="nav-link">
  vuex 源码阅读
</a></li><li class="dropdown-item"><!----> <a href="/blog/question-source-code/vue-template-compiler template 编译流程/" class="nav-link">
  带着问题看源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/router/前端路由/" class="nav-link">
  前端路由
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/svg sprite/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue-ssr/vue-srr 项目搭建/" class="nav-link">
  Vue SSR
</a></li><li class="dropdown-item"><!----> <a href="/blog/javascript/EC AO VO Scope Chain/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/flutter 知识点记录/" class="nav-link">
  Flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack学习笔记/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/low-code-platform/可视化搭建平台（一）- 流程/" class="nav-link">
  可视化搭建平台
</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/广度优先搜索 BFS 和深度优先搜索 DFS/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/3D立体骰子/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/git/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web-safe/web-safe/" class="nav-link">
  Web Safe
</a></li><li class="dropdown-item"><!----> <a href="/blog/minapp/小程序工程化/" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/v8 引擎及其 GC 机制/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div> <a href="https://github.com/Ertsul/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue-source-code/Vue 源码阅读1 引入vue模块/" class="nav-link">
  Vue 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue3-source-code/vue3 响应式原理/" class="nav-link">
  vue3 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue-router/vue-router 源码阅读（一）/" class="nav-link">
  vue-router 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vuex/vuex 源码阅读/" class="nav-link">
  vuex 源码阅读
</a></li><li class="dropdown-item"><!----> <a href="/blog/question-source-code/vue-template-compiler template 编译流程/" class="nav-link">
  带着问题看源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/router/前端路由/" class="nav-link">
  前端路由
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/svg sprite/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue-ssr/vue-srr 项目搭建/" class="nav-link">
  Vue SSR
</a></li><li class="dropdown-item"><!----> <a href="/blog/javascript/EC AO VO Scope Chain/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/flutter 知识点记录/" class="nav-link">
  Flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack学习笔记/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/low-code-platform/可视化搭建平台（一）- 流程/" class="nav-link">
  可视化搭建平台
</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/广度优先搜索 BFS 和深度优先搜索 DFS/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/3D立体骰子/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/git/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web-safe/web-safe/" class="nav-link">
  Web Safe
</a></li><li class="dropdown-item"><!----> <a href="/blog/minapp/小程序工程化/" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/v8 引擎及其 GC 机制/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div> <a href="https://github.com/Ertsul/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/question-source-code/vue-template-compiler template 编译流程.html" class="sidebar-link">vue-template-compiler 源码</a></li><li><a href="/blog/question-source-code/vue prop 类型校验.html" class="sidebar-link">vue prop 类型校验源码</a></li><li><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html" class="active sidebar-link">vue 标签内换行文本前后空格</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#vue-template-compiler" class="sidebar-link">vue-template-compiler</a></li><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#查看-vue-template-compiler-源码" class="sidebar-link">查看 vue-template-compiler 源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#compile-函数" class="sidebar-link">compile 函数</a></li><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#parse-函数" class="sidebar-link">parse 函数</a></li><li class="sidebar-sub-header"><a href="/blog/question-source-code/带着问题看源码 - 标签内换行文本前后空格.html#parsehtml-函数" class="sidebar-link">parseHTML 函数</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <p>之所以会有这个问题，是因为在做静态网站的时候，SEO 人员发现文本前后空格的问题，并提出文本前后不要有前后空格的需求。</p> <p>用 SPA 做测试，Vue 在解析 template 中标签文本会有以下两种情况：</p> <ul><li>标签内换行</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  文本
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在浏览器渲染为：</p> <p><img src="/blog/assets/img/q-source-02.170f2bd5.png" alt="标签内换行"></p> <ul><li>标签内不换行</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在浏览器渲染为：</p> <p><img src="/blog/assets/img/q-source-01.d832ecc4.png" alt="标签内不换行"></p> <p>之前也做过 SSR 的测试。发现该问题不仅仅在 SSR，SPA 也存在该问题。</p> <p>对问题定位：</p> <p>在解析 vue 单文件 template 模版的时候对换行做了特殊处理，也就是 <a href="https://www.npmjs.com/package/vue-loader" target="_blank" rel="noopener noreferrer">vue-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个 loader。</p> <p>如果不是通过 .vue 文件渲染页面，而是通过 template 模版字符串渲染，则不会 vue-loader 转化逻辑，而是通过 vue 内部的 compile 和 compileToFunctions 进行转化。主要代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token parameter">baseCompile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token punctuation">,</span>
  options</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> ref$1 <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> compile <span class="token operator">=</span> ref$1<span class="token punctuation">.</span>compile<span class="token punctuation">;</span>
<span class="token keyword">var</span> compileToFunctions <span class="token operator">=</span> ref$1<span class="token punctuation">.</span>compileToFunctions<span class="token punctuation">;</span>
</code></pre></div><p>不管是通过 vue-loader 还是内部编译逻辑，其核心都是使用 <a href="https://www.npmjs.com/package/vue-template-compiler" target="_blank" rel="noopener noreferrer">vue-template-compiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个插件。</p> <h2 id="vue-template-compiler"><a href="#vue-template-compiler" class="header-anchor">#</a> <a href="https://www.npmjs.com/package/vue-template-compiler" target="_blank" rel="noopener noreferrer">vue-template-compiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>查看文档，发现有 vue-template-compiler 有一个 whitespace 配置项：</p> <ul><li>preserve：默认项。
<ul><li>元素标签之间的<strong>纯空白文本节点</strong>被压缩为一个空格。</li> <li>所有其他空格按原样保留。</li></ul></li> <li>condense
<ul><li>如果元素标签之间的<strong>纯空白文本节点包含新行</strong>，则会被删除。否则，它会被压缩为一个空格。</li> <li><strong>非纯空格文本节点</strong>内的连续空格被压缩为一个空格。</li></ul></li></ul> <p>在 vue 项目中执行 <code>vue inspect &gt; output.js</code> 查看 webpack 配置，找到 vue-loader 的配置，有如下配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">compilerOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">whitespace</span><span class="token operator">:</span> <span class="token string">'condense'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>发现 vue-loader 的配置选项中的 compilerOptions 的 whitespace 设置为 'condense'。查看 <a href="https://vue-loader.vuejs.org/zh/options.html" target="_blank" rel="noopener noreferrer">vue-loader 文档链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，有 <a href="https://vue-loader.vuejs.org/zh/options.html#compileroptions" target="_blank" rel="noopener noreferrer">compilerOptions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置说明，该配置项最终的配置就是 vue-template-compler 的 whitespace 配置。</p> <p><img src="/blog/assets/img/vue-source-02.2bc38667.png" alt="vue-source-02"></p> <h2 id="查看-vue-template-compiler-源码"><a href="#查看-vue-template-compiler-源码" class="header-anchor">#</a> 查看 vue-template-compiler 源码</h2> <h3 id="compile-函数"><a href="#compile-函数" class="header-anchor">#</a> compile 函数</h3> <p>文件<code>vue-template-compiler/build.js</code>，使用的 compile 方法定义的主要代码为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCompilerCreator</span> <span class="token punctuation">(</span><span class="token parameter">baseCompile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createCompiler</span> <span class="token punctuation">(</span><span class="token parameter">baseOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">compile</span> <span class="token punctuation">(</span>
      <span class="token parameter">template<span class="token punctuation">,</span>
      options</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">var</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">detectErrors</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>ast<span class="token punctuation">,</span> warn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        compiled<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
        compiled<span class="token punctuation">.</span>tips <span class="token operator">=</span> tips<span class="token punctuation">;</span>
        <span class="token keyword">return</span> compiled
      <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">compile</span><span class="token operator">:</span> compile
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token punctuation">,</span>
  options</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">ast</span><span class="token operator">:</span> ast<span class="token punctuation">,</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> compile <span class="token operator">=</span> ref<span class="token punctuation">.</span>compile<span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>compile <span class="token operator">=</span> compile<span class="token punctuation">;</span>
</code></pre></div><p>compile 函数的定义：通过 createCompilerCreator 高阶函数返回的函数获取 createCompiler，再通过函数 createCompiler 返回的对象获取 compile 函数。</p> <p>compile 函数的执行：实际上就是执行<code>createCompilerCreator -&gt; createCompiler -&gt; compile -&gt; baseCompile</code>，compile 方法内部主要执行传入的 baseCompile 函数。</p> <p>梳理下来，compile 函数主要执行逻辑的就是传入 createCompilerCreator 函数的 baseCompile 实参.</p> <p>而 baseCompile 函数内部执行解析逻辑的是 parse 函数，流程跟常规的编译器基本一样，分为三个：</p> <ul><li>parse 解析</li> <li>optimize 优化</li> <li>generate 生成</li></ul> <h3 id="parse-函数"><a href="#parse-函数" class="header-anchor">#</a> parse 函数</h3> <p>主要作用是将代码解析成 AST。</p> <p>parse 函数的参数有两个：</p> <ul><li>template 模板字符串</li> <li>option 配置项</li></ul> <p>函数内部先处理 options 并定义了一系列工具函数，然后调用 parseHTML 解析 template，最后返回根节点 root。</p> <p>主要源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parse</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token punctuation">,</span>
  options</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 options</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 定义工具函数</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 调用 parseHTML 函数</span>
    <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span> 
      <span class="token comment">// options</span>
      <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start$1<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">end</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">end</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end$1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">chars</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">chars</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">comment</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">comment</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> root
  <span class="token punctuation">}</span>
</code></pre></div><p>传递给 parseHTML 的参数除了 template 模版和 options 选项外，还有四个函数：</p> <ul><li>start: 处理开始标签。主要逻辑为：为当前的标签创建 AST 对象，将当前 AST 对象入 stack 栈，最后将当前 AST 赋值给 currentParent 当作下一个标签的父节点。</li> <li>end: 处理结束标签。判断当前标签是否为栈顶元素，并出栈。</li> <li>chars: 处理文本字符串。上面提及的 whitespace 配置项就是在这里面处理的。</li> <li>comment: 处理注释。</li></ul> <h3 id="parsehtml-函数"><a href="#parsehtml-函数" class="header-anchor">#</a> parseHTML 函数</h3> <p>这里根据下面的 html 字符串整理流程：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
  	文本
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>开始循环遍历 html 字符串，直到 html 全部遍历完。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><strong>第一次循环。</strong></p> <p>匹配标签开始标志<code>&lt;</code>，根据当前匹配到的索引 textEnd 判断标签当前文本类型：</p> <ul><li>textEnd 为 0：当前 html 以标签开始。</li> <li>textEnd 大于 0：当前 html 以文本开始。</li> <li>textEnd 小于 0：html 遍历结束。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">var</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>回到例子，html 匹配标签开始标志<code>&lt;</code>，textEnd 为 0，说明当前 html 是以标签开始。</p> <p>接着进入 parseStartTag 处理函数，该函数主要是获取标签名，还有标签在当前 html 中的开始索引 start 和结束索引 end。<code>{ tagName: 'div', attrs: [], start: 0, unarySlash: '', end: 5 }</code></p> <p>然后通过 advance 函数将 html 剔除开始标签字符串。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">advance</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  index <span class="token operator">+=</span> n<span class="token punctuation">;</span>
  html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后执行通过参数传入 parseHTML 函数的 options.start，该函数会根据当前标签创建 AST 元素对象，并将当前 AST 对象的 parent 设置为父节点 currentParent，最后将 AST 对象入栈 stack，并将当前 AST 赋值给 currentParent 当作下一个标签的父节点。</p> <p>由于第一次循环，root 为空，会将当前 AST 元素对象赋值给 root 变量。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">parstHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start$1<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">var</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> currentParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      root <span class="token operator">=</span> element<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkRootConstraints</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentParent <span class="token operator">=</span> element<span class="token punctuation">;</span>
      stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">closeElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第一次循环结束，会得到：</p> <p>下次循环的 html：</p> <div class="language-html extra-class"><pre class="language-html"><code>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
  	文本
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>stack:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>第二次循环。</strong></p> <p>剩下的 html 匹配标签开始标志<code>&lt;</code>，textEnd 大于 0，说明当前 html 到下一个标签之前存在文本。</p> <p>接着通过执行通过<code>text=html.substring(0, textEnd)</code>获取文本内容。</p> <p>然后通过 advance 函数将 html 剔除开始标签字符串。</p> <p>最后执行通过参数传入 parseHTML 函数的 options.chars，该函数会根据不同配置项对文本格式做不同的处理。</p> <p>如果 text 文本做<code>trim()</code>处理之后为空，并且父节点 currentParent 的 children 为空，说明当前 text 文本为父节点和第一个字节点之前的标签内容，则直接将 text 设置为空，直接返回。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">parstHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chars</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inPre <span class="token operator">||</span> text<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> <span class="token function">isTextTag</span><span class="token punctuation">(</span>currentParent<span class="token punctuation">)</span> <span class="token operator">?</span> text <span class="token operator">:</span> <span class="token function">decodeHTMLCached</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// remove the whitespace-only node right after an opening tag</span>
      text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>whitespaceOption<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>whitespaceOption <span class="token operator">===</span> <span class="token string">'condense'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// in condense mode, remove the whitespace node if it contains</span>
        <span class="token comment">// line break, otherwise condense to a single space</span>
        text <span class="token operator">=</span> lineBreakRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        text <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> preserveWhitespace <span class="token operator">?</span> <span class="token string">' '</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果 text 文本做<code>trim()</code>处理之后不为空，则将处理好的 text 文本内容设置为父节点 currentParent 的子节点。</p> <ul><li><p>preserve：默认项。</p> <ul><li>元素标签之间的<strong>纯空白文本节点</strong>被压缩为一个空格。</li> <li>所有其他空格按原样保留。</li></ul></li> <li><p>condense</p> <ul><li>如果元素标签之间的<strong>纯空白文本节点包含新行</strong>，则会被删除。否则，它会被压缩为一个空格。</li> <li><strong>非纯空格文本节点</strong>内的连续空格被压缩为一个空格。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inPre <span class="token operator">&amp;&amp;</span> whitespaceOption <span class="token operator">===</span> <span class="token string">'condense'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// condense consecutive whitespaces into single space</span>
  text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>whitespaceRE<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>回到例子，由于当前获取的文本 text 做<code>trim()</code>处理之后为空，并且父节点 currentParent 的 children 为空，会直接将 text 设置为空，并结束当前循环。</p> <p>第二次循环结束，会得到：</p> <p>下次循环的 html：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
  	文本
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>stack 内容不变。</p> <p><strong>第三次循环。</strong></p> <p>剩下的 html 匹配标签开始标志<code>&lt;</code>，textEnd 为 0，说明当前 html 是以标签开始。</p> <p>接着进入 parseStartTag 处理函数，该函数主要是获取标签名，还有标签在当前 html 中的开始索引 start 和结束索引 end。<code>{ tagName: 'span', attrs: [], start: 8, unarySlash: '', end: 14 }</code></p> <p>然后通过 advance 函数将 html 剔除开始标签字符串。</p> <p>最后执行通过参数传入 parseHTML 函数的 options.start，该函数会根据当前标签创建 AST 元素对象，当后将 AST 对象入栈 stack，并将当前 AST 赋值给 currentParent 当作下一个标签的父节点。</p> <p>第三次循环结束，会得到：</p> <p>下次循环的 html：</p> <div class="language-html extra-class"><pre class="language-html"><code>
  	文本
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>stack:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p><strong>第四次循环。</strong></p> <p>剩下的 html 匹配标签开始标志<code>&lt;</code>，textEnd 大于 0，说明当前 html 到下一个标签之前存在文本。</p> <p>接着通过执行通过<code>text=html.substring(0, textEnd)</code>获取文本内容。</p> <p>然后通过 advance 函数将 html 剔除开始标签字符串。</p> <p>由于 text 文本做<code>trim()</code>处理之后不为空，则将处理好的 text 文本内容设置为父节点 currentParent 的子节点。</p> <p>第四次循环结束，会得到：</p> <p>下次循环的 html：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>stack:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot; 文本 &quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p><strong>第五次循环。</strong></p> <p>剩下 html 匹配标签开始标志<code>&lt;</code>，textEnd 为 0，说明当前 html 是以标签开始。</p> <p>接着在判断是结束标签，则通过 advance 函数将 html 剔除开始标签字符串。</p> <p>然后进入 parseEndTag 函数，调用通过参数传入 parseHTML 函数的 options.end，将当前标签弹出栈 stack。</p> <p>第五次循环结束，会得到：</p> <p>下次循环的 html：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>stack:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;attrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;rawAttrsMap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p><strong>第六次循环</strong>。</p> <p>跟第五次一样。最后 html 遍历结束，stack 也为空了。</p> <p>parseHTML 执行结束，返回 root 根对象。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/question-source-code/vue prop 类型校验.html" class="prev">
        vue prop 类型校验源码
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.cacff740.js" defer></script><script src="/blog/assets/js/2.9a122aa2.js" defer></script><script src="/blog/assets/js/13.58e1ee01.js" defer></script>
  </body>
</html>
