<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ertsul&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Ertsul's Blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.a61027a8.css" as="style"><link rel="preload" href="/blog/assets/js/app.b66e09ab.js" as="script"><link rel="preload" href="/blog/assets/js/2.01f43d5b.js" as="script"><link rel="preload" href="/blog/assets/js/27.d2346f18.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.59172c5d.js"><link rel="prefetch" href="/blog/assets/js/11.a9a38368.js"><link rel="prefetch" href="/blog/assets/js/12.81405ab8.js"><link rel="prefetch" href="/blog/assets/js/13.340b7793.js"><link rel="prefetch" href="/blog/assets/js/14.da73770f.js"><link rel="prefetch" href="/blog/assets/js/15.68dd665b.js"><link rel="prefetch" href="/blog/assets/js/16.1b18f6f2.js"><link rel="prefetch" href="/blog/assets/js/17.a6003fdc.js"><link rel="prefetch" href="/blog/assets/js/18.10097c33.js"><link rel="prefetch" href="/blog/assets/js/19.8beda959.js"><link rel="prefetch" href="/blog/assets/js/20.ed144e89.js"><link rel="prefetch" href="/blog/assets/js/21.de423e2c.js"><link rel="prefetch" href="/blog/assets/js/22.fade2cba.js"><link rel="prefetch" href="/blog/assets/js/23.3cfcc5d1.js"><link rel="prefetch" href="/blog/assets/js/24.166dc48a.js"><link rel="prefetch" href="/blog/assets/js/25.b90b8908.js"><link rel="prefetch" href="/blog/assets/js/26.94d4b6d0.js"><link rel="prefetch" href="/blog/assets/js/28.51ede8e2.js"><link rel="prefetch" href="/blog/assets/js/29.0f1835e4.js"><link rel="prefetch" href="/blog/assets/js/3.f75cd3f2.js"><link rel="prefetch" href="/blog/assets/js/30.1fd7a655.js"><link rel="prefetch" href="/blog/assets/js/31.6d19cae7.js"><link rel="prefetch" href="/blog/assets/js/32.97fa71b8.js"><link rel="prefetch" href="/blog/assets/js/33.3255befe.js"><link rel="prefetch" href="/blog/assets/js/34.a9aa3068.js"><link rel="prefetch" href="/blog/assets/js/35.91dd143a.js"><link rel="prefetch" href="/blog/assets/js/36.30d40a7b.js"><link rel="prefetch" href="/blog/assets/js/37.9f49954d.js"><link rel="prefetch" href="/blog/assets/js/38.ab3ff746.js"><link rel="prefetch" href="/blog/assets/js/39.38768e80.js"><link rel="prefetch" href="/blog/assets/js/4.e47cc3d3.js"><link rel="prefetch" href="/blog/assets/js/40.0f197f7e.js"><link rel="prefetch" href="/blog/assets/js/41.5e4ab3e3.js"><link rel="prefetch" href="/blog/assets/js/42.9994d485.js"><link rel="prefetch" href="/blog/assets/js/43.0044b9c3.js"><link rel="prefetch" href="/blog/assets/js/44.e8b2c414.js"><link rel="prefetch" href="/blog/assets/js/5.a20b4046.js"><link rel="prefetch" href="/blog/assets/js/6.644e427c.js"><link rel="prefetch" href="/blog/assets/js/7.85076821.js"><link rel="prefetch" href="/blog/assets/js/8.f3b8dd3a.js"><link rel="prefetch" href="/blog/assets/js/9.45c1220d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.a61027a8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Ertsul's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue-source-code/Vue 源码阅读1 引入vue模块/" class="nav-link">
  Vue 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/svg sprite/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/js/EC AO VO Scope Chain/" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/flutter 知识点记录/" class="nav-link">
  Flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack学习笔记/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/low-code-platform/可视化搭建平台（一）- 流程/" class="nav-link">
  可视化搭建平台
</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/广度优先搜索 BFS 和深度优先搜索 DFS/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/3D立体骰子/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/git/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web-safe/web-safe/" class="nav-link">
  Web Safe
</a></li><li class="dropdown-item"><!----> <a href="/blog/minapp/小程序工程化/" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/v8 引擎及其 GC 机制/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Ertsul/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue-source-code/Vue 源码阅读1 引入vue模块/" class="nav-link">
  Vue 源码
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/svg sprite/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/js/EC AO VO Scope Chain/" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/flutter 知识点记录/" class="nav-link">
  Flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack学习笔记/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/low-code-platform/可视化搭建平台（一）- 流程/" class="nav-link">
  可视化搭建平台
</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/广度优先搜索 BFS 和深度优先搜索 DFS/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/3D立体骰子/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/git/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/web-safe/web-safe/" class="nav-link">
  Web Safe
</a></li><li class="dropdown-item"><!----> <a href="/blog/minapp/小程序工程化/" class="nav-link">
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/v8 引擎及其 GC 机制/" class="nav-link">
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Ertsul/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/flutter/flutter 知识点记录.html" class="sidebar-link">flutter 知识点记录</a></li><li><a href="/blog/flutter/flutter 字母联动列表.html" class="active sidebar-link">flutter 字母联动列表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/flutter 字母联动列表.html#布局" class="sidebar-link">布局</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/flutter 字母联动列表.html#gesturedetector" class="sidebar-link">GestureDetector</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/flutter 字母联动列表.html#主要思路" class="sidebar-link">主要思路</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>网上的第三方包，用的最多就是：<a href="https://pub.dev/packages/azlistview" target="_blank" rel="noopener noreferrer">azListView<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>但是它有 bug：当列表到达页面底部的时候，滑动最后几个字母，还会触发回弹到屏幕顶部。如下：</p> <p><img src="https://i.loli.net/2020/12/07/Kkad3H7t82GXyLq.gif" alt="azlisview_list.gif"></p> <p>经过分析，一开始以为是 ListView 的 physics 属性影响，<a href="https://book.flutterchina.club/chapter6/intro.html" target="_blank" rel="noopener noreferrer">physics <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>介绍：</p> <ul><li>ClampingScrollPhysics：Android下微光效果。</li> <li>BouncingScrollPhysics：iOS下弹性效果。</li> <li>NeverScrollableScrollPhysics：禁止滚动。</li></ul> <p>但是设置该属性其实没有效果，还是会出现上面的问题。</p> <p>后面多次测试 ListView，发现是 ListView 跳转事件 jumpTo 的影响，后面改用 animateTo，animateTo 的用法如下：</p> <div class="language- extra-class"><pre class="language-text"><code>_scrollController.animateTo( offsetHeight, duration: Duration(milliseconds: 10), curve: Curves.linear, )
</code></pre></div><p>但是又有新的问题：</p> <ul><li>当连续快速滑动的时候，这个 duration 相当于多了个防抖的作用。</li> <li>点击字母列表的时候，也会有问题。</li></ul> <p>效果如下：</p> <p><img src="https://i.loli.net/2020/12/07/iQeIG5ay6TCEKHU.gif" alt="animato_list.gif"></p> <p>azListView 存在问题：</p> <ul><li>azListView 包体较大；</li> <li>存在的问题修改源码耗时较久。</li></ul> <hr> <p>自己实现，效果如下：</p> <p><img src="https://i.loli.net/2020/12/07/Ts58gGam3C6FBI2.gif" alt="alphabet_link_list.gif"></p> <h2 id="布局"><a href="#布局" class="header-anchor">#</a> 布局</h2> <p>整个页面用 Stack 布局，分为：</p> <ul><li>主列表（头部 + 城市列表）</li> <li>主列表顶部字母提示</li> <li>字母列表（字母列表 + 当前字母提示）</li></ul> <p>代码如下：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">/// _buildBody</span>
<span class="token class-name">Widget</span> <span class="token function">_buildBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">_buildMainListView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_buildSusBarView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">Positioned</span><span class="token punctuation">(</span>
        top<span class="token punctuation">:</span> <span class="token function">duSetHeight</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> <span class="token function">duSetWidth</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">Row</span><span class="token punctuation">(</span>
          mainAxisAlignment<span class="token punctuation">:</span> <span class="token class-name">MainAxisAlignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
          children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">_buildAlphabetListView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="gesturedetector"><a href="#gesturedetector" class="header-anchor">#</a> GestureDetector</h2> <p><a href="https://book.flutterchina.club/chapter8/gesture.html" target="_blank" rel="noopener noreferrer">GestureDetector 文档链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>onVerticalDragUpdate：滑动更新</li> <li>onVerticalDragEnd：滑动结束</li> <li>...</li></ul> <h2 id="主要思路"><a href="#主要思路" class="header-anchor">#</a> 主要思路</h2> <h3 id="_1-初始化的时候-先计算获取以下数值。"><a href="#_1-初始化的时候-先计算获取以下数值。" class="header-anchor">#</a> 1.初始化的时候，先计算获取以下数值。</h3> <ul><li>计算主列表每个字母分组需要跳转的 offsetTopList 和每个字母分组所占用的高度 groupHeight；</li></ul> <p>【计算：遍历字母列表，字母的 offsetTop = 之前的所有字母所有的 offsetTop 累加；当前字母的 groupHeight = 每个主列表项 itemHeight * 每个字母分组数量。】</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">/// 计算主列表每个字母需要滚动的距离和每个字母项所占用的高度</span>
<span class="token keyword">void</span> <span class="token function">_calcEachLetterOffsetTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> _alphabetList <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">;</span>

  <span class="token comment">/// offset top</span>
  _alphabetListOffsetTopMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// '#' header offsetTop</span>
  _alphabetListOffsetTopMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      widget<span class="token punctuation">.</span>headerHeight<span class="token punctuation">;</span> <span class="token comment">// 第一个字母，滚动距离为顶部 header 高度 offsettop</span>
  <span class="token comment">/// height</span>
  _alphabetListHeightMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      widget<span class="token punctuation">.</span>headerHeight<span class="token punctuation">;</span> <span class="token comment">// '#' header height</span>
  _alphabetListHeightMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>
      widget<span class="token punctuation">.</span>alphabetCountMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> widget<span class="token punctuation">.</span>mainListItemHeight <span class="token operator">+</span>
          widget<span class="token punctuation">.</span>guideBarHeight<span class="token punctuation">;</span> <span class="token comment">// 第一个字母所占用的高度</span>
  <span class="token comment">// 第二项开始循环</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _alphabetList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> _curLetter <span class="token operator">=</span> _alphabetList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 当前字母</span>

    <span class="token comment">// 保存当前字母项的高度</span>
    _alphabetListHeightMap<span class="token punctuation">[</span>_curLetter<span class="token punctuation">]</span> <span class="token operator">=</span>
        widget<span class="token punctuation">.</span>alphabetCountMap<span class="token punctuation">[</span>_curLetter<span class="token punctuation">]</span> <span class="token operator">*</span> widget<span class="token punctuation">.</span>mainListItemHeight <span class="token operator">+</span>
            widget<span class="token punctuation">.</span>guideBarHeight<span class="token punctuation">;</span>

    <span class="token comment">// 计算主列表每一个字母项需要滚动的 offsetTop（之前的所有字母所有的 offsetTop 累加）</span>
    double _offsetTopSum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>int j <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> _preLetter <span class="token operator">=</span> _alphabetList<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 之前的字母</span>
      <span class="token comment">// 将之前所有字母的高度累加</span>
      <span class="token comment">// 主列表每个字母单元高度 = 子项数量 * 子项高度 + 主列表导航条高度</span>
      _offsetTopSum <span class="token operator">+=</span>
          widget<span class="token punctuation">.</span>alphabetCountMap<span class="token punctuation">[</span>_preLetter<span class="token punctuation">]</span> <span class="token operator">*</span> widget<span class="token punctuation">.</span>mainListItemHeight <span class="token operator">+</span>
              widget<span class="token punctuation">.</span>guideBarHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _alphabetListOffsetTopMap<span class="token punctuation">[</span>_curLetter<span class="token punctuation">]</span> <span class="token operator">=</span>
        _offsetTopSum <span class="token operator">+</span> widget<span class="token punctuation">.</span>headerHeight<span class="token punctuation">;</span> <span class="token comment">// 设置当前字母的滚动 offsetTop</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>获取主列表不需要滚动的字母列表。</li></ul> <p>【计算：从字母表后面遍历，将每个字母分组所占用的高度 groupHeight 进行累加，与屏幕的高度进行比较，如果累加结果小于屏幕高度，则对该字母进行标记。】</p> <p>主要代码如下：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">/// 获取主列表不需要滚动的字母列表</span>
<span class="token keyword">void</span> <span class="token function">_getNotScrollAlphebetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> _screenHeight <span class="token operator">=</span>
      <span class="token function">duSetHeight</span><span class="token punctuation">(</span><span class="token class-name">MediaQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 屏幕高度</span>
  <span class="token comment">// final _screenHeight = duSetHeight(size.height);</span>
  double _heightSum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断那些字母不需要触发列表滚动，从后面字母开始循环累加，判断是否小于屏幕高度</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> _curLetter <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    bool _ifLessThanScreenHeight <span class="token operator">=</span>
        _heightSum <span class="token operator">+</span> _alphabetListHeightMap<span class="token punctuation">[</span>_curLetter<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> _screenHeight<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_ifLessThanScreenHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _heightSum <span class="token operator">+=</span> _alphabetListHeightMap<span class="token punctuation">[</span>_curLetter<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 累加</span>
      _notScrollAlphabetLst<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _curLetter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加到列表</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-滑动主列表-获取当前的字母-更新右侧字母表状态和更新顶部字母导航条。"><a href="#_2-滑动主列表-获取当前的字母-更新右侧字母表状态和更新顶部字母导航条。" class="header-anchor">#</a> 2. 滑动主列表，获取当前的字母，更新右侧字母表状态和更新顶部字母导航条。</h3> <ul><li>获取主列表当前滑动位置的 screenOffsetTop；</li> <li>遍历 offsetTopList，判断 screenOffsetTop 在哪两个字母的区间内，则可以定位到目标字母。</li></ul> <p>主要代码如下：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">/// 更新字母表当前激活的字母</span>
<span class="token keyword">void</span> <span class="token function">_updateAlphebetListView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 主列表上锁中（滚动执行中），直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_mainListScrollLock <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> _alphabetList <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">;</span>
  <span class="token comment">// 监听主列表滚动，判断主列表的 offsetTop 在哪两个字母的 offsetTop 区间内，将右侧字母导航列表激活为当前字母</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不为最后一个字母 + 主列表 offsetTop 大于当前字母的 offsetTop + 主列表的 offsetTop 小于下一个字母的 offsetTop</span>
    bool _ifInCurRange <span class="token operator">=</span> i <span class="token operator">!=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
        _scrollController<span class="token punctuation">.</span>offset <span class="token operator">&lt;=</span>
            _alphabetListOffsetTopMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        _scrollController<span class="token punctuation">.</span>offset <span class="token operator">&gt;</span>
            _alphabetListOffsetTopMap<span class="token punctuation">[</span>_alphabetList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_ifInCurRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _selectedAlphabetIndex <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// 设置字母表选中字母索引</span>
      _mainListScrollLock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-滑动字母表-获取当前的字母-主列表跳转到目标字母和更新顶部字母导航条。"><a href="#_3-滑动字母表-获取当前的字母-主列表跳转到目标字母和更新顶部字母导航条。" class="header-anchor">#</a> 3. 滑动字母表，获取当前的字母，主列表跳转到目标字母和更新顶部字母导航条。</h3> <ul><li>获取字母表当前位置相对于字母表容器顶部的高度 paddingOffsetTop【获取字母表当前位置对于视窗的高度 - 字母表容器顶部的高度相对于视窗的高度】;</li> <li>计算每个字母项占用字母表容器的高度 alphabetItemHeight 【(字母表容器的高度 - padding) / 字母数量】；</li> <li>获取当前索引，paddingOffsetTop / alphabetItemHeight；</li> <li>获取当前字母和主列表 offsetTopList 滚动高度，</li> <li>更新视图。</li></ul> <p>主要代码如下：</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">/// 滑动字母表：滚动主列表 + 更新字母列表</span>
<span class="token keyword">void</span> <span class="token function">_onVerticalDragUpdateHandle</span><span class="token punctuation">(</span><span class="token class-name">DragUpdateDetails</span> event<span class="token punctuation">,</span> int index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/// 更新字母表</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_alphabetListOffset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取字母表的 margin top</span>
    <span class="token class-name">RenderBox</span> _box <span class="token operator">=</span> _alphabetListKey<span class="token operator">?</span><span class="token punctuation">.</span>currentContext<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">findRenderObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _alphabetListOffset <span class="token operator">=</span> _box<span class="token punctuation">.</span><span class="token function">localToGlobal</span><span class="token punctuation">(</span><span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 字母表的padding</span>
  double _alphabetPadding <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetListItemHeight<span class="token punctuation">;</span>
  <span class="token comment">// 计算当前字母项索引：(当前活动的 dy - 字母表的 marginTop - 字母表的 padding) / 每个字母所占的高度</span>
  int _curActiveLetterIndex <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>globalPosition<span class="token punctuation">.</span>dy <span class="token operator">-</span> _alphabetListOffset<span class="token punctuation">.</span>dy <span class="token operator">-</span> _alphabetPadding<span class="token punctuation">)</span> <span class="token operator">/</span>
              widget<span class="token punctuation">.</span>alphabetListItemHeight<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_curActiveLetterIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 滑出字母表区域上面，保持为 0</span>
    _selectedAlphabetIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_curActiveLetterIndex <span class="token operator">&gt;=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 滑出字母表区域下面，保持为最后一个</span>
    _selectedAlphabetIndex <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _selectedAlphabetIndex <span class="token operator">=</span> _curActiveLetterIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 滚动主列表</span>
  <span class="token class-name">String</span> _curLetter <span class="token operator">=</span> widget<span class="token punctuation">.</span>alphabetList<span class="token punctuation">[</span>_selectedAlphabetIndex<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前字母项</span>
  <span class="token function">_scrollMainList</span><span class="token punctuation">(</span>_curLetter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-当主列表已经滑动到底部-继续滑动字母表剩下的字母-判断当前字母时候标记为不需要滚动主列表-直接滑动列表底部-不滑动到字母分组位置。"><a href="#_4-当主列表已经滑动到底部-继续滑动字母表剩下的字母-判断当前字母时候标记为不需要滚动主列表-直接滑动列表底部-不滑动到字母分组位置。" class="header-anchor">#</a> 4.当主列表已经滑动到底部，继续滑动字母表剩下的字母，判断当前字母时候标记为不需要滚动主列表，直接滑动列表底部，不滑动到字母分组位置。</h3> <p>主要代码如下：</p> <div class="language- extra-class"><pre class="language-text"><code>/// 滚动主列表 void _scrollMainList(String letter) {  if (_notScrollAlphabetLst.contains(letter)) {    // 当前字母不需要滚动    _scrollController        .jumpTo(_scrollController.position.maxScrollExtent); // 滚动到列表底部    return;  }  _scrollController.jumpTo(    _alphabetListOffsetTopMap[letter],  ); }
</code></pre></div><h3 id="_5-主列表滚动锁。"><a href="#_5-主列表滚动锁。" class="header-anchor">#</a> 5. 主列表滚动锁。</h3> <p>为防止出现上次滚动还没结束，下次滚动就开始执行的问题，给主列表滚动上锁。</p> <div class="language- extra-class"><pre class="language-text"><code>/// 更新字母表当前激活的字母 void _updateAlphebetListView() {  // 主列表上锁中（滚动执行中），直接返回  if (_mainListScrollLock) return;  // ... }
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/4/2021, 10:52:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/flutter/flutter 知识点记录.html" class="prev">
        flutter 知识点记录
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b66e09ab.js" defer></script><script src="/blog/assets/js/2.01f43d5b.js" defer></script><script src="/blog/assets/js/27.d2346f18.js" defer></script>
  </body>
</html>
